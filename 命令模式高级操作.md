# 命令模式高级操作

## 166. 范围操作符

**场景**：对特定范围的行执行命令

**基础范围**：

**示例文件**（行号）：

```text
1  First line
2  Second line
3  Third line
4  Fourth line
5  Fifth line
```

**操作示例**：

- `:3,5d` - 删除第 3-5 行
- `:2,4s/line/LINE/` - 在第 2-4 行替换
- `:1,3t$` - 复制 1-3 行到文件末尾
- `:2,4m6` - 移动 2-4 行到第 6 行后

**特殊范围符号**：

- `%` - 整个文件 (`:% s/old/new/g`)
- `.` - 当前行 (`:.,5d` 从当前到第 5 行)
- `$` - 最后一行 (`:10,$d` 从第 10 行到末尾)
- `'<,'>` - 可视选中区域
- `+/-` - 相对行号 (`:+2,+5d` 向下 2-5 行)

## 167. 全局命令 (global)

**场景**：对匹配模式的所有行执行操作

**基础语法**：`:g/pattern/command`

**示例 1：删除包含特定文本的行**

**初始**：

```javascript
console.log("Debug 1");
const x = 10;
console.log("Debug 2");
const y = 20;
console.log("Debug 3");
```

**操作**：`:g/console.log/d`

**目标**：

```javascript
const x = 10;
const y = 20;
```

**示例 2：在匹配行后添加内容**

**初始**：

```javascript
function foo() {}
function bar() {}
```

**操作**：`:g/^function/normal o  // TODO: implement`

**目标**：

```javascript
function foo() {
  // TODO: implement
}
function bar() {
  // TODO: implement
}
```

**更多 global 示例**：

- `:g/error/p` - 打印包含 "error" 的行
- `:g!/pattern/d` - 删除不匹配的行（`:v/pattern/d` 相同）
- `:g/^$/d` - 删除空行
- `:g/pattern/t$` - 复制匹配行到文件末尾
- `:g/pattern/m0` - 移动匹配行到文件开头

## 168. 反向全局命令 (vglobal)

**场景**：对不匹配模式的行执行操作

**语法**：`:v/pattern/command` 或 `:g!/pattern/command`

**示例 1：只保留注释行**

**初始**：

```javascript
// This is important
const x = 10;
// Keep this too
const y = 20;
delete this line;
```

**操作**：`:v/^\/\//d` (删除不是注释的行)

**目标**：

```javascript
// This is important
// Keep this too
```

**示例 2：删除空行和只有空格的行**

**操作**：`:v/\S/d` (删除不包含非空白字符的行)

## 169. 组合命令

**场景**：在一行中执行多个命令

**语法**：使用 `|` 分隔命令

**示例 1：替换并保存**

```vim
:%s/old/new/g | w
```

**示例 2：删除行并调整光标**

```vim
:5,10d | normal gg
```

**示例 3：多个替换**

```vim
:%s/foo/bar/g | %s/baz/qux/g | w
```

## 170. 命令行窗口

**场景**：编辑复杂的命令

**操作**：

- `q:` - 打开命令历史窗口
- `q/` - 打开搜索历史窗口
- `Ctrl-f` - 在命令行模式下打开命令窗口

**使用场景**：

```text
在命令窗口中，你可以：
- 使用 Vim 编辑命令
- 搜索历史命令
- 复制粘贴命令
- 修改后 Enter 执行
```

**示例**：

1. `q:` 打开命令窗口
2. 找到之前的复杂命令
3. 使用 Vim 编辑修改
4. `Enter` 执行修改后的命令

## 171. 子命令和管道

**场景**：使用外部命令处理文本

**示例 1：排序行**

```vim
:5,10!sort
```

对 5-10 行使用系统 sort 命令排序

**示例 2：格式化 JSON**

```vim
:%!jq .
```

使用 jq 格式化整个文件

**示例 3：删除重复行**

```vim
:%!uniq
```

**示例 4：统计单词**

```vim
:!wc -w %
```

统计当前文件的单词数

**常用外部命令**：

- `!sort` - 排序
- `!uniq` - 去重
- `!grep pattern` - 过滤
- `!column -t` - 对齐列
- `!python -m json.tool` - JSON 格式化
- `!prettier --parser babel` - JavaScript 格式化

## 172. 读取和写入命令

**场景**：读取或写入文件的特定部分

**示例 1：插入文件内容**

```vim
:r filename.txt
```

在当前行下插入文件内容

**示例 2：插入命令输出**

```vim
:r !date
```

插入当前日期

**示例 3：写入部分内容**

```vim
:10,20w partial.txt
```

将 10-20 行写入新文件

**示例 4：追加到文件**

```vim
:5,10w >> log.txt
```

将 5-10 行追加到 log.txt

**示例 5：读取 URL 内容**

```vim
:r !curl https://api.example.com/data
```

## 173. 寄存器操作

**场景**：在命令中使用寄存器

**示例 1：从寄存器粘贴到命令**

假设寄存器 a 中有 "pattern"

```vim
:g/<Ctrl-r>a/d
```

等同于 `:g/pattern/d`

**示例 2：保存到寄存器**

```vim
:let @a = 'some text'
```

**示例 3：在命令中使用寄存器内容**

```vim
:s/<Ctrl-r>a/<Ctrl-r>b/g
```

## 174. 条件命令

**场景**：根据条件执行命令

**示例 1：检查文件类型**

```vim
:if &filetype == 'javascript' | set shiftwidth=2 | endif
```

**示例 2：条件替换**

```vim
:if search('pattern')
:  %s/old/new/g
:endif
```

**示例 3：检查并创建目录**

```vim
:if !isdirectory('backup')
:  !mkdir backup
:endif
```

## 175. 循环命令

**场景**：重复执行命令

**示例 1：For 循环生成行**

```vim
:for i in range(1, 10)
:  put ='Item ' . i
:endfor
```

**结果**：

```text
Item 1
Item 2
...
Item 10
```

**示例 2：遍历列表**

```vim
:for item in ['apple', 'banana', 'cherry']
:  put =item
:endfor
```

**示例 3：批量处理**

```vim
:for file in ['file1.txt', 'file2.txt', 'file3.txt']
:  execute 'e ' . file
:  %s/old/new/g
:  w
:endfor
```

## 176. 函数定义和调用

**场景**：创建自定义命令

**示例：清理空白行的函数**

```vim
:function! CleanWhitespace()
:  let save_pos = getpos('.')
:  %s/\s\+$//e
:  %s/\n\{3,}/\r\r/e
:  call setpos('.', save_pos)
:endfunction

" 调用
:call CleanWhitespace()
```

**示例 2：带参数的函数**

```vim
:function! WrapWithTag(tag)
:  normal! `<
:  execute 'normal! i<' . a:tag . '>'
:  normal! `>
:  execute 'normal! a</' . a:tag . '>'
:endfunction

" 调用
:'<,'>call WrapWithTag('div')
```

## 177. 命令缩写

**场景**：创建命令别名

**示例**：

```vim
:cnoreabbrev W w
:cnoreabbrev Q q
:cnoreabbrev Wq wq
:cnoreabbrev WQ wq
```

**自定义命令**：

```vim
:command! JsonFormat %!jq .
:command! RemoveTrailing %s/\s\+$//e
:command! SortLines %!sort
```

**使用**：

```vim
:JsonFormat
:RemoveTrailing
:SortLines
```

## 178. 执行缓冲区内容

**场景**：将文本作为命令执行

**示例**：

```vim
" 文件中有这些行：
set number
set relativenumber
colorscheme desert

" 执行：
:1,3@:  " 执行 1-3 行作为命令
```

**从寄存器执行**：

```vim
" 寄存器 q 中有命令
:@q
```

## 179. 复杂的搜索替换

**场景**：使用表达式和函数进行替换

**示例 1：大小写转换**

```vim
:%s/\<\w\+\>/\U&/g
```

所有单词转大写

**示例 2：增量替换**

```vim
:let counter=0 | %s/pattern/\=counter+=1/g
```

将所有 pattern 替换为递增数字

**示例 3：使用函数**

```vim
:function! ProcessMatch(match)
:  return toupper(a:match[0]) . a:match[1:]
:endfunction

:%s/\<\w\+\>/\=ProcessMatch(submatch(0))/g
```

每个单词首字母大写

## 180. 宏与命令结合

**场景**：在命令中使用宏

**示例**：

```vim
" 录制宏到 q
qa
... 操作 ...
q

" 对所有匹配行执行宏
:g/pattern/normal @q
```

**示例 2：对特定范围执行宏**

```vim
:5,20normal @q
```

## 181. 多文件操作

**场景**：对多个文件执行相同操作

**示例 1：在所有打开的 buffer 中替换**

```vim
:bufdo %s/old/new/ge | update
```

**示例 2：在参数列表中的所有文件**

```vim
:args *.js
:argdo %s/var /let /ge | update
```

**示例 3：在所有窗口执行**

```vim
:windo set number
```

**示例 4：在所有标签页执行**

```vim
:tabdo %s/old/new/ge
```
